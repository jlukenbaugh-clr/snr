<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CLR LTE Link Quality Rater - Industry Standards</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #444;
            --excellent-bg: #1b5e20;
            --excellent-text: #c8e6c9;
            --good-bg: #1a4a5e;
            --good-text: #b3e5fc;
            --fair-bg: #f57c00;
            --fair-text: #fff3e0;
            --poor-bg: #b71c1c;
            --poor-text: #ffcdd2;
        }
        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border: #ddd;
            --excellent-bg: #d4edda;
            --excellent-text: #155724;
            --good-bg: #d1ecf1;
            --good-text: #0c5460;
            --fair-bg: #fff3cd;
            --fair-text: #856404;
            --poor-bg: #f8d7da;
            --poor-text: #721c24;
        }
        body { 
            font-family: 'Courier New', monospace; 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            transition: all 0.3s ease;
        }
        input { 
            width: 120px; padding: 8px; margin: 5px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            background: var(--bg-secondary); 
            color: var(--text-primary);
        }
        button { 
            padding: 12px 24px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px;
        }
        button:hover { background: #218838; }
        #themeToggle { background: #6c757d; font-size: 0.9em; float: right; }
        #themeToggle:hover { background: #5a6268; }
        #getTowers { background: #007bff; }
        #getTowers:hover { background: #0056b3; }
        #getLocation { background: #17a2b8; font-size: 0.85em; padding: 8px 16px; }
        #getLocation:hover { background: #117a8b; }
        .rating { 
            font-weight: bold; padding: 12px; margin: 12px 0; 
            border-radius: 6px; text-align: center; 
            border: 2px solid;
        }
        .excellent { background: var(--excellent-bg); color: var(--excellent-text); border-color: #4caf50; }
        .good { background: var(--good-bg); color: var(--good-text); border-color: #2196f3; }
        .fair { background: var(--fair-bg); color: var(--fair-text); border-color: #ff9800; }
        .poor { background: var(--poor-bg); color: var(--poor-text); border-color: #f44336; }
        table { 
            width: 100%; border-collapse: collapse; margin-top: 20px; 
            background: var(--bg-secondary); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            border-radius: 6px; overflow: hidden;
        }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: left; }
        th { background: #007bff; color: white; }
        #standards { 
            background: var(--bg-secondary); 
            padding: 15px; border-radius: 6px; 
            margin-bottom: 20px; font-size: 0.9em; 
            border-left: 4px solid #007bff;
        }
        h1 { color: #007bff; text-align: center; margin-bottom: 10px; }
        h3 { color: var(--text-primary); }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .coord-group { 
            background: var(--bg-secondary); 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        #map { 
            height: 500px; 
            width: 100%; 
            border-radius: 6px; 
            margin: 20px 0;
            border: 2px solid var(--border);
            display: none;
        }
        #towerInfo {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        .tower-item {
            padding: 10px;
            margin: 8px 0;
            background: var(--bg-primary);
            border-left: 3px solid #007bff;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        .error {
            background: var(--poor-bg);
            color: var(--poor-text);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body data-theme="dark">
    <div class="header">
        <h1>üì° LTE Signal Quality Rater</h1>
        <button id="themeToggle">‚òÄÔ∏è Light</button>
    </div>
    <p>Industry-standard ratings for Digi/Palo Alto/etc. modems. Enter values and get per-metric + overall score.</p>
    
    <div id="standards">
        <strong>Ranges used:</strong><br>
        RSSI: Excellent ‚â§-65, Good -65‚Üí-75, Fair -75‚Üí-85, Poor >-85<br>
        RSRP: Excellent ‚â•-80, Good -80‚Üí-95, Fair -95‚Üí-105, Poor ‚â§-105<br>
        RSRQ: Excellent ‚â•-6, Good -6‚Üí-10, Fair -10‚Üí-15, Poor ‚â§-15<br>
        SINR: Excellent ‚â•25, Good 20-25, Fair 13-20, Poor <13<br>
        SNR: Excellent ‚â•25, Good 18-25, Fair 10-18, Poor <10
    </div>
    
    <form id="signalForm">
        <label>RSRQ (dB): <input type="number" id="rsrq" step="0.1" placeholder="-13"></label><br>
        <label>RSRP (dBm): <input type="number" id="rsrp" step="0.1" placeholder="-101"></label><br>
        <label>RSSI (dBm): <input type="number" id="rssi" step="0.1" placeholder="-65"></label><br>
        <label>SNR (dB): <input type="number" id="snr" step="0.1" placeholder="10.8"></label><br>
        <label>SINR (dB): <input type="number" id="sinr" step="0.1" placeholder="6.4"></label><br>
        <button type="submit">Rate Signal</button>
    </form>
    
    <div class="coord-group">
        <strong>üìç Location Coordinates</strong>
        <button id="getLocation">Get Current Location</button><br>
        <label>Latitude: <input type="number" id="latitude" step="0.000001" placeholder="36.4266"></label><br>
        <label>Longitude: <input type="number" id="longitude" step="0.000001" placeholder="-99.3959"></label><br>
        <label>Search Radius (km): <input type="number" id="radius" value="10" min="1" max="100" style="width: 80px;"></label><br>
        <button id="getTowers">üóº Find Nearby Towers</button>
    </div>
    
    <div id="results"></div>
    
    <div id="towerInfo"></div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = null;
        let markers = [];
        const API_KEY = 'pk.53a83342c743a32ab8defc6ba8d94bb3';
        
        // Dark mode toggle
        const toggle = document.getElementById('themeToggle');
        toggle.addEventListener('click', () => {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            toggle.textContent = isDark ? 'üåô Dark' : '‚òÄÔ∏è Light';
            localStorage.setItem('theme', body.getAttribute('data-theme'));
        });
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        toggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        
        // Get current location
        document.getElementById('getLocation').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                    },
                    (error) => {
                        alert('Error getting location: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });
        
        // Find nearby towers
        document.getElementById('getTowers').addEventListener('click', async () => {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const radius = parseFloat(document.getElementById('radius').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid coordinates');
                return;
            }
            
            const towerInfoDiv = document.getElementById('towerInfo');
            towerInfoDiv.style.display = 'block';
            towerInfoDiv.innerHTML = '<div class="loading">üîç Searching for nearby cell towers...</div>';
            
            try {
                // OpenCelliD API endpoint
                const url = `https://opencellid.org/ajax/searchCell.php?key=${API_KEY}&lat=${lat}&lon=${lon}&radius=${radius}&format=json`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.cells && data.cells.length > 0) {
                    displayTowers(data.cells, lat, lon);
                } else {
                    towerInfoDiv.innerHTML = '<div class="error">No cell towers found in this area. Try increasing the search radius.</div>';
                }
            } catch (error) {
                towerInfoDiv.innerHTML = `<div class="error">Error fetching tower data: ${error.message}</div>`;
                console.error('Error:', error);
            }
        });
        
        function displayTowers(towers, userLat, userLon) {
            const towerInfoDiv = document.getElementById('towerInfo');
            const mapDiv = document.getElementById('map');
            
            // Sort by distance
            towers.sort((a, b) => {
                const distA = calculateDistance(userLat, userLon, a.lat, a.lon);
                const distB = calculateDistance(userLat, userLon, b.lat, b.lon);
                return distA - distB;
            });
            
            // Display tower information
            let html = `<h3>üì° Found ${towers.length} Cell Towers</h3>`;
            towers.forEach((tower, index) => {
                const distance = calculateDistance(userLat, userLon, tower.lat, tower.lon);
                const radio = tower.radio ? tower.radio.toUpperCase() : 'Unknown';
                html += `
                    <div class="tower-item">
                        <strong>Tower ${index + 1}</strong> - ${distance.toFixed(2)} km away<br>
                        üì∂ Type: ${radio} | 
                        üè¢ MCC: ${tower.mcc || 'N/A'} | 
                        üì° MNC: ${tower.mnc || 'N/A'} | 
                        üìç Cell: ${tower.cell || 'N/A'}<br>
                        üìè Coordinates: ${tower.lat.toFixed(6)}, ${tower.lon.toFixed(6)}<br>
                        ${tower.range ? `üìä Range: ${tower.range}m` : ''}
                    </div>
                `;
            });
            towerInfoDiv.innerHTML = html;
            
            // Initialize or update map
            mapDiv.style.display = 'block';
            if (!map) {
                map = L.map('map').setView([userLat, userLon], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([userLat, userLon], 12);
                markers.forEach(m => map.removeLayer(m));
                markers = [];
            }
            
            // Add user location marker
            const userMarker = L.marker([userLat, userLon], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            userMarker.bindPopup('<b>Your Location</b>');
            markers.push(userMarker);
            
            // Add tower markers
            towers.forEach((tower, index) => {
                const distance = calculateDistance(userLat, userLon, tower.lat, tower.lon);
                const radio = tower.radio ? tower.radio.toUpperCase() : 'Unknown';
                
                const towerMarker = L.marker([tower.lat, tower.lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                towerMarker.bindPopup(`
                    <b>Tower ${index + 1}</b><br>
                    Type: ${radio}<br>
                    Distance: ${distance.toFixed(2)} km<br>
                    Cell ID: ${tower.cell || 'N/A'}
                `);
                markers.push(towerMarker);
            });
            
            // Fit map to show all markers
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Signal rating form handler
        document.getElementById('signalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vals = {
                rssi: parseFloat(document.getElementById('rssi').value),
                rsrp: parseFloat(document.getElementById('rsrp').value),
                rsrq: parseFloat(document.getElementById('rsrq').value),
                sinr: parseFloat(document.getElementById('sinr').value),
                snr: parseFloat(document.getElementById('snr').value)
            };
            
            function rateRSSI(v) { 
                if (v <= -65) return {text: 'Excellent', cls: 'excellent'};
                if (v <= -75) return {text: 'Good', cls: 'good'};
                if (v <= -85) return {text: 'Fair', cls: 'fair'};
                return {text: 'Poor', cls: 'poor'};
            }
            function rateRSRP(v) {
                if (v >= -80) return {text: 'Excellent', cls: 'excellent'};
                if (v >= -95) return {text: 'Good', cls: 'good'};
                if (v >= -105) return {text: 'Fair', cls: 'fair'};
                return {text: 'Poor', cls: 'poor'};
            }
            function rateRSRQ(v) {
                if (v >= -6) return {text: 'Excellent', cls: 'excellent'};
                if (v >= -10) return {text: 'Good', cls: 'good'};
                if (v >= -15) return {text: 'Fair', cls: 'fair'};
                return {text: 'Poor', cls: 'poor'};
            }
            function rateSINR(v) {
                if (v >= 25) return {text: 'Excellent', cls: 'excellent'};
                if (v >= 20) return {text: 'Good', cls: 'good'};
                if (v >= 13) return {text: 'Fair', cls: 'fair'};
                return {text: 'Poor', cls: 'poor'};
            }
            function rateSNR(v) {
                if (v >= 25) return {text: 'Excellent', cls: 'excellent'};
                if (v >= 18) return {text: 'Good', cls: 'good'};
                if (v >= 10) return {text: 'Fair', cls: 'fair'};
                return {text: 'Poor', cls: 'poor'};
            }
            
            const rates = {
                rssi: rateRSSI(vals.rssi),
                rsrp: rateRSRP(vals.rsrp),
                rsrq: rateRSRQ(vals.rsrq),
                sinr: rateSINR(vals.sinr),
                snr: rateSNR(vals.snr)
            };
            
            const poorCount = Object.values(rates).filter(r => r.cls === 'poor').length;
            const fairCount = Object.values(rates).filter(r => r.cls === 'fair').length;
            let overall = 'Excellent'; let cls = 'excellent';
            if (poorCount >= 1 || fairCount >= 3) { overall = 'Fair'; cls = 'fair'; }
            if (poorCount >= 2 || fairCount >= 4) { overall = 'Poor'; cls = 'poor'; }
            
            let html = `
                <h3>Overall: <span class="rating ${cls}">${overall}</span></h3>
                <div class="rating ${rates.rsrq.cls}">RSRQ ${vals.rsrq || '?'}: ${rates.rsrq.text}</div>
                <div class="rating ${rates.rsrp.cls}">RSRP ${vals.rsrp || '?'}: ${rates.rsrp.text}</div>
                <div class="rating ${rates.rssi.cls}">RSSI ${vals.rssi || '?'}: ${rates.rssi.text}</div>
                <div class="rating ${rates.snr.cls}">SNR ${vals.snr || '?'}: ${rates.snr.text}</div>
                <div class="rating ${rates.sinr.cls}">SINR ${vals.sinr || '?'}: ${rates.sinr.text}</div>
                <table>
                    <tr><th>Metric</th><th>Value</th><th>Rating</th></tr>
                    <tr><td>RSRQ</td><td>${vals.rsrq || '?'}</td><td>${rates.rsrq.text}</td></tr>
                    <tr><td>RSRP</td><td>${vals.rsrp || '?'}</td><td>${rates.rsrp.text}</td></tr>
                    <tr><td>RSSI</td><td>${vals.rssi || '?'}</td><td>${rates.rssi.text}</td></tr>
                    <tr><td>SNR</td><td>${vals.snr || '?'}</td><td>${rates.snr.text}</td></tr>
                    <tr><td>SINR</td><td>${vals.sinr || '?'}</td><td>${rates.sinr.text}</td></tr>
                </table>
            `;
            document.getElementById('results').innerHTML = html;
        });
    </script>
</body>
</html>
